<html>
<head>
  <title>LASS pm2.5 map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
   <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyCO-pUGf5JuLoj0EIad1MJo5-9YfDyGQaI"></script>

  <style>
    #map{ height: 100% }
  </style>
</head>
<body>

<p id="form"></p>
<img src="img/loading.svg" style="width:100%;height:100%;" id="loading">



<div id="map"></div>



<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-dsv.v1.min.js"></script>
<script src="https://d3js.org/d3-request.v1.min.js"></script>



<script
 src="https://code.jquery.com/jquery-3.1.1.min.js"
 integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
 crossorigin="anonymous">
 </script>


  
  <script src="leaflet-idw.js"></script>

  <script>

// getDistance
function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  // console.log("lat1:"+lat1);
  // console.log("lon1:"+lon1);
  // console.log("lat2:"+lat2);
  // console.log("lon2:"+lon2);

  var R = 6371; // Radius of the earth in km
  var dLat = deg2rad(lat2-lat1);  // deg2rad below
  var dLon = deg2rad(lon2-lon1);
  var a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
    Math.sin(dLon/2) * Math.sin(dLon/2)
    ; 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c; // Distance in km
  // console.log("distance:" + d)
  return d;
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}

function readTextFile(file){
    var rawFile = new XMLHttpRequest();
    var allText;
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function ()
    {
        if(rawFile.readyState === 4)
        {
            if(rawFile.status === 200 || rawFile.status == 0)
            {
                allText = rawFile.responseText;
                // alert(allText);
            }
        }
    }
    rawFile.send(null);
    return allText;
}

var Sites = []
function getBoxData(){
    var data = readTextFile("airbox.csv");
    var lines = data.split("\n")

    for(var i=1;i<lines.length-1;i++){
        var line_split_data = lines[i].split(',');
        var deviceDict = {"device_id":line_split_data[0], "PM2.5":parseFloat(line_split_data[1]), "timestamp":line_split_data[2], "lat":parseFloat(line_split_data[3]), "lng":parseFloat(line_split_data[4])}
        Sites.push(deviceDict);
    }
    console.log("get Data done.")
}

// get nearest site
function getNearestSite(loadingRemove){
    console.log("start")
    start = new Date().getTime();
    var nearestSite;
    var smallestDistance = 100000;
    var count = 0
    for(var siteIndex = 0; siteIndex < Sites.length; siteIndex++){      
        count += 1
        distance = getDistanceFromLatLonInKm(gpsPosition[0], gpsPosition[1], Sites[siteIndex].lat, Sites[siteIndex].lng)
        if(smallestDistance >= distance){
          smallestDistance = distance;
          nearestSite = Sites[siteIndex];
        }
    }
    end = new Date().getTime();

    console.log("sec:" + (end-start) + " (ms)")
    console.log("count:" + count)
    loadingRemove();

    return nearestSite;
}

// get location of client
var gpsPosition;
function init(){
  getBoxData();
  poisition = getLocation();
  
}
init();

// marker of your location
var marker;


// get initial position
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

var nearestSite;
var start;
var end;
function showPosition(position) {
    gpsPosition = [position.coords.latitude, position.coords.longitude]
    // gpsPositionG = gpsPosition;
    
    nearestSite = getNearestSite(loadingRemove);
    // end = new Date().getTime();
    // console.log("sec:" + (end-start) + " (ms)")
    // loadingRemove();   
}

function loadingRemove(){
  var loading = document.getElementById("loading");
  loading.remove();  
  showButton();  
  initMap();  
  
}

var form = document.getElementById("form");
function showButton(){
  form.innerHTML = '<button onclick="panToYourPosition()">Your Location</button><input type="text" name="name" id="addr" value="Taipei 101" /><button onclick="goToPosition()">Go!</button>'
}

// go to queried position
function goToPosition(){
  if (typeof marker == 'object'){
    map.removeLayer(marker)
  }
  var addrValue = document.getElementById("addr").value;

  var geocoder = new google.maps.Geocoder();
  var coor = [];

  // geocode and set view
  geocoder.geocode( { 'address': addrValue}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var latitude = results[0].geometry.location.lat();
      var longitude = results[0].geometry.location.lng();
      // coor = [latitude, longitude];
      coor.push(latitude);
      coor.push(longitude);

      queriedPosition = coor;
      map.setView(queriedPosition, 13);
      marker = L.marker(queriedPosition).addTo(map);
    }
  });
}

function getAirQualityPic(airValue){
    var airPicUrl;
    console.log("airValue:" + airValue)
  
    if(airValue >= 45){
        if(airValue >= 59){
            if(airValue >= 65){
                if(airValue >= 71){
                    airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-10.png";
                }
                else{
                    airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-9.png"; 
                }
            }
            else{
                airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-8.png";
            }
        }
        else if(airValue > 50){
            airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-7.png";  
        }
        else{
            airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-6.png";   
        }        
    }
    else{
        if(airValue >= 24){
            if(airValue >= 36){
                if(airValue >= 42){
                    airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-5.png";
                }
                else{
                    airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-4.png";
                }
            }
            else{
                airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-3.png";
            }
        }
        else if(airValue >= 12){
            airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-2.png";
        }
        else{
            airPicUrl = "https://www.taiwanstat.com/realtime/pm2.5/img/PM2.5-1.png";
        }
    }
  return airPicUrl;
}

var airVlaue;
var airQualityPicUrl;

// pan to your location
function panToYourPosition() {
  if (typeof marker == 'object'){
    map.removeLayer(marker)
  }
  map.setView(gpsPosition, 13);

  
  
  deviceId = nearestSite["device_id"]
  pm25Value = nearestSite["PM2.5"]
  timestamp = nearestSite["timestamp"]

  airQualityPicUrl = getAirQualityPic(pm25Value)
  // create popup contents
  var customPopup = "<p style='font-size:20px'>Air Quality<br/>DeviceID:" + deviceId + "<br/>PM2.5:" + pm25Value + "<br/>Timestamp:" + timestamp + "<br/>Status:<br/><img src=" + airQualityPicUrl + " width=150px></p>";
  
  
  // specify popup options 
  var customOptions =
      {
      'maxWidth': '1000',
      'className' : 'custom'
      }
  marker = L.marker(gpsPosition).addTo(map).bindPopup(customPopup, customOptions).openPopup();
}








var data;
var map;

function initMap(){

  // read csv file
d3.csv("./LASS_sample.csv", function(error, d) {
  if (error) throw error;
  data = d;
  
  // initialize the map
  map = L.map('map').setView([23.5, 120.7420], 8);
  panToYourPosition();
  var idw = L.idwLayer([
    [23.5, 120.7420, 0.2]//, // lat, lng, intensity
    // [50.6, 30.4, 0.5],
  //  ...
  ], {opacity: 0.3, cellSize: 10, exp: 2, max: 1200}).addTo(map);

  // load a tile layer

L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibmNrdXN0YXQiLCJhIjoiY2l2ZXVvNDRhMDBxajJ6bzZzOGwxdTU2eiJ9.A0Dp9WJrs4FPYhh_i327CA', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18
}).addTo(map);


/*
var idw = L.idwLayer([
    [50.5, 30.5, 0.2], // lat, lng, intensity
    [50.6, 30.4, 0.5],
    ...
], {opacity: 0.3, cellSize: 10, exp: 2, max: 1200}).addTo(map);

*/

/*
var points = data.map(function(d) {
  //console.log(d.order);
  return [d.gps_lat, d.gps_lon, d.s_d0];
});
map.options.maxZoom = 16;
var idw = L.idwLayer(points, {opacity: 0.3, cellSize: 10, exp: 2, max: 100,  maxZoom: 10,
            minZoom: 8, gradient : d.s_d0 
          }).addTo(map);

*/  



   function getColor(d){
             return     d < 11? "#9CFF9C":
                        d < 23? "#31FF00":
                        d < 35? "#31CF00":
                        d < 41? "#FFFF00":
                        d < 47? "#FFCF00":
                        d < 53? "#FF9A00":
                        d < 58? "#FF6464":
                        d < 64? "#FF0000":
                        d < 70? "#990000":
                                "#CE30FF";
    }



 var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
        labels = [],
        grades = [0,11,23,35,41,47,53,58,64,70];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += labels.push(
                '<i style="background:' + getColor(grades[i]+1) + ';">&nbsp;&nbsp;&nbsp;&nbsp;</i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] : '+'));
        }
  div.innerHTML = labels.join('<br>');

        return div;
    };

    legend.addTo(map);


var circles = [];





for (var i = 0; i < data.length; ++i) {
 // console.log(data[i].SiteName);
  if (0 <= data[i].s_d0 && data[i].s_d0 < 11){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#9CFF9C',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
 

  }
  else if (11 <= data[i].s_d0 && data[i].s_d0 < 21){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#31FF00',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
  else if (21 <= data[i].s_d0 && data[i].s_d0 < 31){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#31CF00',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
    else if (31 <= data[i].s_d0 && data[i].s_d0 < 41){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#FFFF00',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
    else if (41 <= data[i].s_d0 && data[i].s_d0 < 51){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#FFCF00',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
    else if (51 <= data[i].s_d0 && data[i].s_d0 < 61){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#FF9A00',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
    else if (61 <= data[i].s_d0 && data[i].s_d0 < 71){
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#FF6464',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);
  }
  else{
  var circle = L.circle([data[i].gps_lat, data[i].gps_lon], {
    color: '#FF0000',

    fillOpacity: 0.5,
    radius: 5000
}).addTo(map);    
  }



  circle.bindPopup("SiteName : " + data[i].s_d0 +  "<br /> Date : " + data[i].timestamp + "<br /> PM 2.5 : " + data[i].s_d0);

}



//var circles = [];

// for




});

}





  </script>
</body>
</html>
